<!DOCTYPE html>

<html lang="en" xmlns="http://www.w3.org/1999/xhtml">
<head>
    <meta charset="utf-8" />
    <title>Pokemon Moveset Generator</title>
    <link rel="stylesheet" href="css/main.css">
    <!--<script src="js/main.js"></script>-->
</head>
<body>
    <main>
        <h1>Pokemon Sample Moveset Generator</h1>

        <p>You can get sample movesets for certain Pokemon is a specific type range. 
        Please select at least one type: </p>
        <div id="type-select">
            <select id="type1">
                <option value="">Type 1</option>
                <option value="normal">Normal</option>
                <option value="fighting">Fighting</option>
                <option value="flying">Flying</option>
                <option value="poison">Poison</option>
                <option value="ground">Ground</option>
                <option value="rock">Rock</option>
                <option value="bug">Bug</option>
                <option value="ghost">Ghost</option>
                <option value="steel">Steel</option>
                <option value="fire">Fire</option>
                <option value="water">Water</option>
                <option value="grass">Grass</option>
                <option value="electric">Electric</option>
                <option value="psychic">Psychic</option>
                <option value="ice">Ice</option>
                <option value="dragon">Dragon</option>
                <option value="dark">Dark</option>
                <option value="fairy">Fairy</option>
            </select>
            <select id="type2">
                <option value="">Type 2 (Optional)</option>
                <option value="normal">Normal</option>
                <option value="fighting">Fighting</option>
                <option value="flying">Flying</option>
                <option value="poison">Poison</option>
                <option value="ground">Ground</option>
                <option value="rock">Rock</option>
                <option value="bug">Bug</option>
                <option value="ghost">Ghost</option>
                <option value="steel">Steel</option>
                <option value="fire">Fire</option>
                <option value="water">Water</option>
                <option value="grass">Grass</option>
                <option value="electric">Electric</option>
                <option value="psychic">Psychic</option>
                <option value="ice">Ice</option>
                <option value="dragon">Dragon</option>
                <option value="dark">Dark</option>
                <option value="fairy">Fairy</option>
            </select>

            <button name="generate" id="generate">Generate</button>
        </div>

        <p id="status">Ready to search!</p>

        <h2>Results:</h2>
        <div id="results">
            <p>No results yet</p>
        </div>
    </main>

    <footer>
        <a href="https://pokeapi.co/">Pokemon API Link</a><br>
        <a href="doc.html">Documentation Link</a>
    </footer>

    <script>
        "using strict";

        window.onload = (e) => { document.querySelector("#generate").onclick = generateButtonClicked }

        let type1;
        let type2;
        let pokemonList1; // Contains the unfiltered list of pokemon
        let pokemonList2 = []; // Contains the url of the pokemon
        let pokemonList3 = []; // Contains the list of pokemon
        let pokemonList4 = []; // Contains the list of pokemon after sorting through types
        let moveList = [];

        const API_URL = "https://pokeapi.co/api/v2/";

        // Maybe save the type selected
        


        // Generate button
        function generateButtonClicked() {
            // Reset all the lists
            pokemonList1 = undefined;
            pokemonList2 = [];
            pokemonList3 = [];
            pokemonList4 = [];

            // Get the types that were selected
            type1 = document.querySelector("#type1").value;
            type2 = document.querySelector("#type2").value;

            // Get a link to the section of the API about selected type1
            let url = API_URL + "type/";
            url += type1;

            // Load information from the section
            getType(url);

        }

        function getType(url) {
            // Create a new XHR object
            let xhr1 = new XMLHttpRequest();

            // Set the onload handler. Called when the data is successfully loaded
            xhr1.onload = typeLoaded;

            // Set the onerror handler. Called when error occurs
            xhr1.onerror = dataError;

            // Open connection and send the request
            xhr1.open("GET", url);
            xhr1.send();
        }

        function typeLoaded(e) {
            // event.target is the xhr object
            let xhr1 = e.target;

            // xhr.responseText is JSON file we just downloaded
            // console.log(xhr.responseText);

            // Turned the text into a JavaScript object
            let obj = JSON.parse(xhr1.responseText);

            // Contains the general information of type1 like moves and pokemon etc.
            pokemonList1 = obj;

            // Go through the first pokemon list and add the url to the Pokemon to
            // list two. All these pokemon are of type type1
            for (let i = 0; i < pokemonList1.pokemon.length; i++) {
                pokemonList2.push(pokemonList1.pokemon[i]);

            }

            // Call of the urls in list 2 so as to get the actual info of each pokemon
            for (let i = 0; i < pokemonList2.length; i++) {
                getPokemon(pokemonList2[i].pokemon.url);
            }


            // If there is no results, print an error and return
            if (!obj) {
                document.querySelector("#status").innerHTML = "<b>No results found for '" + type1 + "'</b>";
                return;
            }

            // Use the pokemon property to make a list of pokemon gotten from the 
            // pokemon

            // - Make sure to check whether the Pokemon also contains type2. If yes,
            // add it a ?list?
            

            // - Once we have all the pokemon that fulfil the type requirement, make pokemon
            // objects using their names and sprites
            // - Have to write algorithm to pick the most optimal moves, but for now just put
            // the first 4 moves in the list
            // - To finish up, use all the pokemon objects to make boxes that will be displayed
            // on the website

        }

        function getPokemon(url) {
            // Create a new XHR object
            let xhr2 = new XMLHttpRequest();

            // Set the onload handler. Called when the data is successfully loaded
            xhr2.onload = pokemonLoaded;

            // Set the onerror handler. Called when error occurs
            xhr2.onerror = dataError;

            // Open connection and send the request
            xhr2.open("GET", url);
            xhr2.send();
        }

        function pokemonLoaded(e) {
            // event.target is the xhr object
            let xhr2 = e.target;

            // xhr.responseText is JSON file we just downloaded
            // console.log(xhr.responseText);

            // Turned the text into a JavaScript object
            let obj = JSON.parse(xhr2.responseText);

            // Add information of the pokemon to list3
            pokemonList3.push(obj);

            // Run only if a second type was selected
            if (type2 != "") {

                // Go through all its types. If one of them is type2, add the pokemon to list 4
                for (let i = 0; i < obj.types.length; i++) {
                    if (obj.types[i].type.name == type2) {
                        pokemonList4.push(obj);
                    }
                }
            }
            else {
                pokemonList4.push(obj);
            }

            // Make a string to add the pokemon to the HTML
            let bigString = "";

            // Go through ever pokemon in list4
            for (let i = 0; i < pokemonList4.length; i++) {
                let sprite = pokemonList4[i].sprites.front_default; // The sprite of the specific pokemon

                // Build a div for each result
                let line = `<section class = 'pokemon'><p>${pokemonList4[i].name}</p>
                <img src = '${sprite}' title = '${pokemonList4[i].name}'>`;

                line += `<div class = 'moves'>`;

                // Add the first 4 moves to the HTML
                // CHANGE LATER TO INCLUDE ACTUAL CALCULATIONS FOR MOST OPTIMAL MOVES

                /*
                moveList = [];

                
                for (let j = 0; j < pokemonList4[i].moves.length; j++) {
                    getMove(pokemonList4[i].moves[j].move.url);

                }
                */

                if (pokemonList4[i].moves.length == 1) {
                    line += `<p>${pokemonList4[i].moves[0].move.name}`;

                }
                else if (pokemonList4[i].moves.length == 0) {
                    line += `<p><b>Dynamax moves!</b></p>`
                }
                else {
                    /*    Wasn't able to figure out a functional way to give optimal moves
                        let random = 0;
                        let counter = 0;
                        let condition = "attack";
    
                        while (counter < 4) {
                            random = Math.floor(Math.random() * moveList.length);
    
                            if (counter == 2) {
                                condition = "atkStat";
                            }
    
                            if (condition == "attack") {
                                if (moveList[random].type.name == type1 || moveList[random].type.name == type2) {
                                    // Add to string
                                    line += `<p>${moveList[random].name}</p>`;
    
                                    counter += 1;
                                }
                            }
    
                            if (condition == "atkStat") {
                                if (moveList[random].target.name == "user" && moveList[random].stat_changes.length > 0) {
                                    // Add to string
                                    line += `<p>${moveList[random].name}</p>`;
    
                                    counter += 1;
                                }
                            }
                            */


                    for (let j = 0; j < 4; j++) {
                        let random = Math.floor(Math.random() * pokemonList4[i].moves.length);

                        line += `<p>${pokemonList4[i].moves[random].move.name}</p> `;
                    }
                }  

                line += `</div></section>`
                bigString += line;

            }

            document.querySelector("#results").innerHTML = bigString;
        }


        function getMove(url) {
            // Create a new XHR object
            let xhr3 = new XMLHttpRequest();

            // Set the onload handler. Called when the data is successfully loaded
            xhr3.onload = moveLoaded;

            // Set the onerror handler. Called when error occurs
            xhr3.onerror = dataError;

            // Open connection and send the request
            xhr3.open("GET", url);
            xhr3.send();
        }

        function moveLoaded(e) {
            // event.target is the xhr object
            let xhr3 = e.target;

            // xhr.responseText is JSON file we just downloaded
            // console.log(xhr.responseText);

            // Turned the text into a JavaScript object
            let obj = JSON.parse(xhr3.responseText);

            moveList.push(obj);
        }

        function dataError(e) {
            console.log("An error occured");
        }

        // Pokemon class (Not being used yet)
        function createPokemon(name, sprite, moves = [4]) {
            let pokemon = {
                name: name,
                sprite: sprite,
                moves: moves
            }

            return pokemon;
        }

        // Check if the Pokemon is of both types  (Not being used yet)
        function CheckTyping(pokemon) {
            for (let i = 0; i < 2; i++) {
                if (pokemon.types[i].type.name == type2) {
                    return true;
                }
                else {
                    return false;
                }
            }
        }

        // Not being used yet
        function CheckPokemon() {
            for (let i = 0; i < pokemonList3.length; i++) {
                for (let j = 0; i < pokemonList3[i].types.length; i++) {
                    if (pokemonList3[i].types[j].type.name == type2) {
                        pokemonList4.push(pokemonList3[i])
                    }
                }
            }
        }
        
    </script>
</body>
</html>